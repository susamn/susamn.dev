---
import clientsData from '../data/experience/clients.json';
import employersData from '../data/experience/employers.json';

// Helper to parse "YYYY-MM" into a Date object
const parseDate = (dateStr: string) => {
  if (!dateStr) return new Date();
  const d = new Date(dateStr);
  return isNaN(d.getTime()) ? new Date() : d;
};

// Calculate duration in years and months
const getDuration = (start: Date, end: Date) => {
  const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
  const years = Math.floor(months / 12);
  const remainingMonths = months % 12;
  if (years === 0) return `${remainingMonths}mo`;
  if (remainingMonths === 0) return `${years}yr`;
  return `${years}yr ${remainingMonths}mo`;
};

// Normalize and sort data
const processTimelineData = (data: any[]) => {
  return data
    .map(item => {
      const joined = parseDate(item.joined);
      const left = item.left ? parseDate(item.left) : new Date();
      return {
        name: item.name || item.client,
        joined,
        left: item.left ? left : null,
        isCurrent: !item.left,
        duration: getDuration(joined, left)
      };
    })
    .sort((a, b) => a.joined.getTime() - b.joined.getTime());
};

const clients = processTimelineData(clientsData);
const employers = processTimelineData(employersData);

// Calculate timeline bounds
const allDates = [
  ...clients.map(i => i.joined),
  ...clients.map(i => i.left || new Date()),
  ...employers.map(i => i.joined),
  ...employers.map(i => i.left || new Date())
];

const minDate = new Date(Math.min(...allDates.map(d => d.getTime())));
const maxDate = new Date();
const totalDuration = maxDate.getTime() - minDate.getTime();

// Generate year markers
const startYear = minDate.getFullYear();
const endYear = maxDate.getFullYear();

// All years for desktop, fewer for mobile (handled via CSS)
const allYears = Array.from({ length: endYear - startYear + 1 }, (_, i) => startYear + i);
const keyYears = allYears.filter((year, i, arr) => i === 0 || i === arr.length - 1 || year % 5 === 0);

// Helper to get left position (%)
const getPosition = (date: Date) => {
  return ((date.getTime() - minDate.getTime()) / totalDuration) * 100;
};

// Helper to format date
const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
};

// Format date range
const formatRange = (joined: Date, left: Date | null) => {
  const start = formatDate(joined);
  const end = left ? formatDate(left) : 'Present';
  return `${start} — ${end}`;
};
---

<style>
  @keyframes pulse-slow {
    0%, 100% { opacity: 0.4; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.3); }
  }
  .animate-pulse-slow {
    animation: pulse-slow 2.5s ease-in-out infinite;
  }
  .year-marker-middle {
    display: none;
  }
  @media (min-width: 640px) {
    .year-marker-middle {
      display: block;
    }
  }
</style>

<div class="space-y-3">
  <!-- Legend -->
  <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-[10px]">
    <div class="flex items-center gap-1.5">
      <span class="w-2 h-2 rounded-full bg-teal-500"></span>
      <span class="text-stone-500 font-medium">Employer</span>
    </div>
    <div class="flex items-center gap-1.5">
      <span class="w-2 h-2 rounded-full bg-amber-500"></span>
      <span class="text-stone-500 font-medium">Client</span>
    </div>
    <div class="flex items-center gap-1 ml-auto text-stone-400">
      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>Hover for details</span>
    </div>
  </div>

  <!-- Visual Timeline -->
  <div class="relative z-10">
    <!-- Employers Track -->
    <div class="relative h-4 mb-1.5 overflow-visible">
      <div class="absolute inset-x-0 top-1/2 h-px bg-stone-200 -translate-y-1/2"></div>
      {employers.map((item) => {
        const start = getPosition(item.joined);
        const end = getPosition(item.left || new Date());
        const width = Math.max(end - start, 1);

        return (
          <div
            class="group absolute h-3 top-1/2 -translate-y-1/2 cursor-pointer"
            style={{ left: `${start}%`, width: `${width}%` }}
          >
            <div class="absolute inset-0 bg-teal-500/20 rounded-full border border-teal-500/40 group-hover:bg-teal-500/30 group-hover:border-teal-500 transition-all">
              {item.isCurrent && (
                <span class="absolute right-0 top-1/2 -translate-y-1/2 w-2 h-2 bg-teal-500 rounded-full animate-pulse-slow"></span>
              )}
            </div>

            <div class="opacity-0 group-hover:opacity-100 transition-opacity absolute bottom-full left-1/2 -translate-x-1/2 mb-1 z-50 pointer-events-none">
              <div class="bg-stone-800 text-white text-[9px] rounded-md shadow-lg px-2 py-1 whitespace-nowrap">
                <div class="font-semibold text-teal-300">{item.name}</div>
                <div class="text-stone-300">{formatRange(item.joined, item.left)}</div>
                <div class="text-stone-400 text-[8px]">{item.duration}</div>
                <div class="absolute top-full left-1/2 -translate-x-1/2 border-[3px] border-transparent border-t-stone-800"></div>
              </div>
            </div>
          </div>
        );
      })}
    </div>

    <!-- Clients Track -->
    <div class="relative h-4 overflow-visible">
      <div class="absolute inset-x-0 top-1/2 h-px bg-stone-200 -translate-y-1/2"></div>
      {clients.map((item) => {
        const start = getPosition(item.joined);
        const end = getPosition(item.left || new Date());
        const width = Math.max(end - start, 1);

        return (
          <div
            class="group absolute h-3 top-1/2 -translate-y-1/2 cursor-pointer"
            style={{ left: `${start}%`, width: `${width}%` }}
          >
            <div class="absolute inset-0 bg-amber-500/20 rounded-full border border-amber-500/40 group-hover:bg-amber-500/30 group-hover:border-amber-500 transition-all">
              {item.isCurrent && (
                <span class="absolute right-0 top-1/2 -translate-y-1/2 w-2 h-2 bg-amber-500 rounded-full animate-pulse-slow"></span>
              )}
            </div>

            <div class="opacity-0 group-hover:opacity-100 transition-opacity absolute bottom-full left-1/2 -translate-x-1/2 mb-1 z-50 pointer-events-none">
              <div class="bg-stone-800 text-white text-[9px] rounded-md shadow-lg px-2 py-1 whitespace-nowrap">
                <div class="font-semibold text-amber-300">{item.name}</div>
                <div class="text-stone-300">{formatRange(item.joined, item.left)}</div>
                <div class="text-stone-400 text-[8px]">{item.duration}</div>
                <div class="absolute top-full left-1/2 -translate-x-1/2 border-[3px] border-transparent border-t-stone-800"></div>
              </div>
            </div>
          </div>
        );
      })}
    </div>

    <!-- Year markers - in normal flow below tracks -->
    <div class="relative h-4 mt-1 text-[8px] text-stone-400">
      {keyYears.map((year, index) => {
        const isFirst = index === 0;
        const isLast = index === keyYears.length - 1;
        const isMiddle = !isFirst && !isLast;
        const pos = getPosition(new Date(year, 0, 1));

        return (
          <div
            class={`absolute top-0 ${isMiddle ? 'year-marker-middle' : ''}`}
            style={{
              left: isFirst ? '0' : isLast ? 'auto' : `${pos}%`,
              right: isLast ? '0' : 'auto',
              transform: isMiddle ? 'translateX(-50%)' : 'none'
            }}
          >
            <div class="h-1.5 w-px bg-stone-200 mb-0.5"></div>
            <span class={isFirst ? '' : isLast ? 'block text-right' : ''}>{year}</span>
          </div>
        );
      })}
    </div>
  </div>

  <!-- Current Positions (Compact) -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
    {[...employers, ...clients].filter(item => item.isCurrent).map((item) => {
      const isEmployer = employers.includes(item);
      return (
        <div class={`flex items-center gap-2 px-2 py-1.5 rounded-md border ${isEmployer ? 'bg-teal-50/50 border-teal-200' : 'bg-amber-50/50 border-amber-200'}`}>
          <span class={`shrink-0 w-1.5 h-1.5 rounded-full ${isEmployer ? 'bg-teal-500' : 'bg-amber-500'} animate-pulse-slow`}></span>
          <div class="min-w-0 flex-1">
            <div class="font-medium text-stone-700 text-[11px] truncate">{item.name}</div>
            <div class="text-[9px] text-stone-400">{formatDate(item.joined)} — Now · {item.duration}</div>
          </div>
          <span class={`shrink-0 text-[8px] font-medium px-1.5 py-0.5 rounded ${isEmployer ? 'text-teal-600 bg-teal-100' : 'text-amber-600 bg-amber-100'}`}>
            {isEmployer ? 'Employer' : 'Client'}
          </span>
        </div>
      );
    })}
  </div>

  <!-- Collapsible Past Experience -->
  <details class="group">
    <summary class="flex items-center gap-1.5 text-[10px] text-stone-400 cursor-pointer hover:text-stone-600 transition-colors list-none">
      <svg class="w-3 h-3 transition-transform group-open:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      <span>Past experience ({[...employers, ...clients].filter(item => !item.isCurrent).length})</span>
    </summary>
    <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-1.5">
      {[...employers, ...clients]
        .filter(item => !item.isCurrent)
        .sort((a, b) => (b.left?.getTime() || 0) - (a.left?.getTime() || 0))
        .map((item) => {
          const isEmployer = employers.includes(item);
          return (
            <div class="flex items-center gap-1.5 px-2 py-1 rounded bg-stone-50 border border-stone-100">
              <span class={`shrink-0 w-1.5 h-1.5 rounded-full ${isEmployer ? 'bg-teal-400' : 'bg-amber-400'} opacity-60`}></span>
              <div class="min-w-0 flex-1">
                <div class="font-medium text-stone-600 text-[10px] truncate">{item.name}</div>
                <div class="text-[8px] text-stone-400 truncate">{item.duration}</div>
              </div>
            </div>
          );
        })}
    </div>
  </details>
</div>
